<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Engineer Weekï½œç·šä¸ŠæŒ‘æˆ°ï¼ˆå…ç™»å…¥ï¼æ‰‹æ©Ÿå¯ç©ï¼å³æ™‚æ’è¡Œæ¦œï¼‰</title>
  <!-- Tailwind CDN -->
  <script defer crossorigin="anonymous" src="https://cdn.tailwindcss.com"></script>
  <!-- React UMD + ReactDOM UMD -->
  <script defer crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script defer crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Supabase JS UMD -->
  <script defer crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- Babel è½‰è­¯ JSXï¼ˆåƒ…ç¤ºç¯„ç”¨é€”ï¼‰ -->
  <script defer crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body{background:#000}
    #errorBox{display:none;margin:16px auto;max-width:960px;padding:12px;border-radius:12px;background:#2b1e1e;color:#ffd7d7;border:1px solid #472727;font-family:ui-monospace,Consolas,monaco,monospace;white-space:pre-wrap}
  </style>
</head>
<body class="bg-black text-white">
  <div id="root"></div>
  <div id="errorBox"></div>

  <!--
    æˆ‘å€‘ç”¨ Babel ç›´æ¥åœ¨ç€è¦½å™¨è½‰è­¯ JSXï¼Œç‚ºé¿å…è¼‰å…¥æ¬¡åºå•é¡Œï¼š
    1) æ‰€æœ‰å¤–éƒ¨è…³æœ¬çš†ä½¿ç”¨ deferï¼Œä¿è­‰ä¾åºåœ¨ DOMContentLoaded å‰è¼‰å…¥ã€‚
    2) é€™æ®µ text/babel ä»£ç¢¼å®£å‘Šäº† presetsï¼Œä¸¦åœ¨ DOMContentLoaded è§¸ç™¼å¾ŒåŸ·è¡Œã€‚
  -->
  <script type="text/babel" data-presets="env,react">
  window.addEventListener('DOMContentLoaded', () => {
    const showError = (msg) => {
      const box = document.getElementById('errorBox');
      box.style.display = 'block';
      box.textContent = msg;
      console.error(msg);
    };

    try {
      // ä¾è³´æª¢æŸ¥ï¼ˆé¿å…ç¬¬ä¸‰æ–¹è¼‰å…¥å¤±æ•—å°è‡´ Script errorï¼‰
      if (!window.React || !window.ReactDOM) {
        showError('[Boot] React/ReactDOM è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– CDNã€‚');
        return;
      }
      if (!window.supabase) {
        showError('[Boot] Supabase SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– CDNã€‚');
        return;
      }

      const { useEffect, useMemo, useRef, useState } = React;

      // ========= Supabase Cloud Config =========
      const SUPABASE_URL = "https://iudtlababxabhlxstfry.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1ZHRsYWJhYnhhYmhseHN0ZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3OTQwMzIsImV4cCI6MjA3NzM3MDAzMn0.ly_s5nLCXBvFM7DToOaAI9Ip0v4MGqxamTGqAxpDsko";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.supabaseClient = supabase; // æ–¹ä¾¿åœ¨ Console é™¤éŒ¯

      // ========= Utils =========
      const nowTS = () => new Date().toISOString();
      const PLANTS = ["å—ç§‘", "ä¸­ç§‘", "é¾æ½­", "ç«¹ç§‘", "å°ä¸­", "å…¶ä»–"];

      // ========= Supabase helpers =========
      async function sbFetchLeaderboard() {
      try {
        const { data, error } = await supabase
          .from("scores")
          .select("*")
          .order("score", { ascending: false })
          .limit(500);
        if (error) throw error;
        const modeMap = { easy: "å…¥é–€ 1,000ms", pro: "é«˜æ‰‹ 750ms", insane: "ç‹‚ç†± 500ms", "2048": "2048" };
        return (data || []).map((d) => ({
          ...d,
          // å¾Œç«¯å¯èƒ½æ˜¯ modelabelï¼ˆæœªåŠ é›™å¼•è™Ÿå»ºç«‹ï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ "modeLabel"ï¼ˆæœ‰å¤§å°å¯«ï¼‰
          modeLabel: d.modeLabel ?? d.modelabel ?? modeMap[d.mode] ?? d.mode,
        }));
      } catch (e) {
        console.warn("[Supabase] fetch leaderboard failed", e);
        return null;
      }
    }

      async function sbSubmitScore(entry) {
      try {
        const modeMap = { easy: "å…¥é–€ 1,000ms", pro: "é«˜æ‰‹ 750ms", insane: "ç‹‚ç†± 500ms", "2048": "2048" };
        const label = modeMap[entry.mode] || entry.mode;
        // é‡å°ä½ çš„è³‡æ–™è¡¨ç›®å‰ç‚º NOT NULL çš„ modelabel æ¬„ä½ï¼Œæ˜ç¢ºæä¾›å€¼
        const insertable = {
          id: entry.id,
          name: entry.name,
          plant: entry.plant,
          dept: entry.dept ?? null,
          mode: entry.mode,
          target: entry.target,
          elapsed: entry.elapsed,
          score: entry.score,
          modelabel: label, // æ³¨æ„ï¼šå°å¯«ï¼Œç¬¦åˆéŒ¯èª¤è¨Šæ¯ä¸­çš„å¯¦éš›æ¬„ä½å
          created_at: entry.created_at,
        };
        const { data, error } = await supabase.from("scores").insert([insertable]).select();
        if (error) throw error;
        console.log("[Supabase] insert ok", data);
        return { ok: true };
      } catch (e) {
        console.warn("[Supabase] submit failed", e);
        return { ok: false, error: e?.message || String(e) };
      }
    }

      // ========= Reaction è¨ˆæ™‚æŒ‘æˆ° =========
      function ReactionGame({ onScore }) {
        const MODES = [
          { id: "easy", label: "å…¥é–€ 1,000ms", target: 1000 },
          { id: "pro", label: "é«˜æ‰‹ 750ms", target: 750 },
          { id: "insane", label: "ç‹‚ç†± 500ms", target: 500 },
        ];

        const [mode, setMode] = useState(MODES[0]);
        const [running, setRunning] = useState(false);
        const [startTs, setStartTs] = useState(null);
        const [elapsed, setElapsed] = useState(0);
        const rafRef = useRef(null);

        const pretty = (ms) => `${Math.round(ms)} ms`;
        const diff = Math.abs(elapsed - mode.target);
        const score = Math.max(0, 1000 - Math.round(diff));

        const anim = () => {
          if (!running || !startTs) return;
          const e = performance.now() - startTs;
          setElapsed(e);
          rafRef.current = requestAnimationFrame(anim);
        };

        useEffect(() => () => rafRef.current && cancelAnimationFrame(rafRef.current), []);

        const start = () => {
          setElapsed(0);
          setRunning(true);
          const t = performance.now();
          setStartTs(t);
          rafRef.current = requestAnimationFrame(anim);
        };
        const stop = () => {
          setRunning(false);
          if (rafRef.current) {
            cancelAnimationFrame(rafRef.current);
            rafRef.current = null;
          }
          setStartTs(null); // å‡çµé¡¯ç¤º
        };
        const share = () => {
          stop();
          onScore({ mode: mode.id, target: mode.target, elapsed: Math.round(elapsed), score, created_at: nowTS() });
        };

        return (
          <div className="w-full" role="group" aria-label="Reaction Game">
            <div className="grid grid-cols-1 gap-2 sm:grid-cols-3">
              {MODES.map((m) => (
                <button
                  key={m.id}
                  className={"w-full rounded-2xl px-4 py-2 text-sm sm:text-base shadow " + (mode.id === m.id ? "bg-yellow-400/90 text-black" : "bg-neutral-800 text-white")}
                  onClick={() => setMode(m)}
                  disabled={running}
                  aria-pressed={mode.id === m.id}
                >
                  {m.label}
                </button>
              ))}
            </div>

            <div className="mt-4 rounded-3xl bg-gradient-to-br from-slate-900 via-slate-800 to-black p-6 shadow-xl">
              <div className="text-center">
                <p className="text-xs uppercase tracking-widest text-slate-400">ç›®æ¨™æ™‚é–“</p>
                <p className="text-2xl font-bold text-yellow-300">{pretty(mode.target)}</p>
              </div>

              <div className="mt-6 flex items-center justify-center">
                <div className="flex size-56 items-center justify-center rounded-full border-[10px] border-yellow-400/40 bg-slate-900/60 text-4xl font-extrabold text-white sm:size-64" aria-live="polite">
                  {pretty(elapsed)}
                </div>
              </div>
              <p className="mt-2 text-center text-xs text-slate-400">
                {running ? "è¨ˆæ™‚ä¸­â€¦" : startTs === null ? "å·²åœæ­¢ï¼Œæ™‚é–“å·²å‡çµ" : "å°±ç·’"}
              </p>

              <div className="mt-6 grid grid-cols-3 gap-2">
                <button className="rounded-2xl bg-neutral-800 px-4 py-3 text-white shadow md:text-base" onClick={() => { setElapsed(0); setRunning(false); }} disabled={running}>é‡ç½®</button>
                {!running ? (
                  <button className="rounded-2xl bg-yellow-400 px-4 py-3 font-semibold text-black shadow md:text-base" onClick={start}>é–‹å§‹</button>
                ) : (
                  <button className="animate-pulse rounded-2xl bg-emerald-400 px-4 py-3 font-semibold text-black shadow md:text-base" onClick={stop}>åœæ­¢</button>
                )}
                <button className="rounded-2xl bg-blue-500 px-4 py-3 font-semibold text-white shadow md:text-base" onClick={share} disabled={running || score <= 0} title={score <= 0 ? "å…ˆå®Œæˆä¸€å±€å†ä¸Šå‚³æˆç¸¾" : "ä¸Šå‚³é€™å±€åˆ†æ•¸"}>ä¸Šå‚³æˆç¸¾ï¼ˆ{score}ï¼‰</button>
              </div>
              <p className="mt-3 text-center text-xs text-slate-400">åˆ†æ•¸ï¼1000 âˆ’ |å¯¦éš›æ™‚é–“ âˆ’ ç›®æ¨™æ™‚é–“|ï¼ˆè¶Šæ¥è¿‘è¶Šé«˜ï¼‰</p>
            </div>
          </div>
        );
      }

      // ========= 2048 =========
      function Game2048({ onScore }) {
        const SIZE = 4;
        const [board, setBoard] = useState(Array(16).fill(0));
        const [score, setScore] = useState(0);
        const [moves, setMoves] = useState(0);
        const [over, setOver] = useState(false);
        const boardRef = useRef(null);

        const idx = (r, c) => r * SIZE + c;
        const spawn = (b) => {
          const empties = b.map((v, i) => (v === 0 ? i : -1)).filter((i) => i >= 0);
          if (!empties.length) return b;
          const pos = empties[Math.floor(Math.random() * empties.length)];
          const val = Math.random() < 0.9 ? 2 : 4;
          const nb = [...b];
          nb[pos] = val;
          return nb;
        };

        const reset = () => {
          let b = Array(16).fill(0);
          b = spawn(spawn(b));
          setBoard(b);
          setScore(0);
          setMoves(0);
          setOver(false);
          setTimeout(() => boardRef.current?.focus(), 0);
        };

        useEffect(() => { reset(); }, []);

        const slide = (arr) => {
          const nums = arr.filter((v) => v !== 0);
          const out = [];
          let gained = 0;
          for (let i = 0; i < nums.length; i++) {
            if (i < nums.length - 1 && nums[i] === nums[i + 1]) {
              const v = nums[i] * 2;
              out.push(v);
              gained += v;
              i++;
            } else out.push(nums[i]);
          }
          while (out.length < SIZE) out.push(0);
          return { row: out, gained };
        };

        const rotate = (b) => {
          const nb = Array(16).fill(0);
          for (let r = 0; r < SIZE; r++) for (let c = 0; c < SIZE; c++) nb[idx(c, SIZE - 1 - r)] = b[idx(r, c)];
          return nb;
        };

        const canMove = (b) => {
          if (b.some((v) => v === 0)) return true;
          for (let r = 0; r < SIZE; r++) {
            for (let c = 0; c < SIZE; c++) {
              const v = b[idx(r, c)];
              if (r + 1 < SIZE && b[idx(r + 1, c)] === v) return true;
              if (c + 1 < SIZE && b[idx(r, c + 1)] === v) return true;
            }
          }
          return false;
        };

        const moveLeft = (b) => {
          let gainedTotal = 0;
          const nb = [...b];
          for (let r = 0; r < SIZE; r++) {
            const row = [0, 1, 2, 3].map((c) => nb[idx(r, c)]);
            const { row: srow, gained } = slide(row);
            gainedTotal += gained;
            for (let c = 0; c < SIZE; c++) nb[idx(r, c)] = srow[c];
          }
          return { nb, gainedTotal };
        };

        const move = (dir) => {
          if (over) return;
          let b = [...board];
          let rotated = 0;
          if (dir === "ArrowUp") rotated = 1;
          if (dir === "ArrowRight") rotated = 2;
          if (dir === "ArrowDown") rotated = 3;
          for (let i = 0; i < rotated; i++) b = rotate(b);

          const { nb, gainedTotal } = moveLeft(b);
          let back = nb;
          for (let i = 0; i < (4 - rotated) % 4; i++) back = rotate(back);

          if (back.join(",") !== board.join(",")) {
            back = spawn(back);
            setBoard(back);
            setScore((s) => s + gainedTotal);
            setMoves((m) => m + 1);
            if (!canMove(back)) setOver(true);
          }
        };

        // touch & keyboard
        const touch = useRef(null);
        const onTouchStart = (e) => {
          const t = e.changedTouches[0];
          touch.current = { x: t.clientX, y: t.clientY };
        };
        const onTouchEnd = (e) => {
          if (!touch.current) return;
          const t = e.changedTouches[0];
          const dx = t.clientX - touch.current.x;
          const dy = t.clientY - touch.current.y;
          const ax = Math.abs(dx), ay = Math.abs(dy);
          if (Math.max(ax, ay) < 20) return;
          if (ax > ay) move(dx > 0 ? "ArrowRight" : "ArrowLeft");
          else move(dy > 0 ? "ArrowDown" : "ArrowUp");
          touch.current = null;
        };
        const onKeyDown = (e) => {
          if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(e.key)) {
            e.preventDefault();
            move(e.key);
          }
        };

        const submit = () => onScore({ type: "2048", mode: "2048", score, moves, created_at: nowTS() });

        return (
          <div className="w-full select-none" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
            <div className="mb-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="rounded-xl border border-white/10 px-3 py-1 text-xs text-slate-300">
                  åˆ†æ•¸ï¼š<span className="font-bold text-yellow-300">{score}</span>
                </div>
                <div className="rounded-xl border border-white/10 px-3 py-1 text-xs text-slate-300">æ­¥æ•¸ï¼š{moves}</div>
              </div>
              <div className="flex items-center gap-2">
                <button className="rounded-xl bg-neutral-800 px-3 py-2 text-xs text-white" onClick={reset}>é‡æ–°é–‹å§‹</button>
                <button className="rounded-xl bg-blue-500 px-3 py-2 text-xs font-semibold text-white" onClick={submit} disabled={score <= 0}>ä¸Šå‚³åˆ†æ•¸</button>
              </div>
            </div>

            <div
              ref={boardRef}
              tabIndex={0}
              onKeyDown={onKeyDown}
              className="grid grid-cols-4 gap-2 rounded-3xl bg-neutral-900 p-3 shadow-inner outline-none focus:ring-2 focus:ring-yellow-400/40"
              aria-label="2048 æ£‹ç›¤ï¼ˆå¯ç”¨æ–¹å‘éµæ“ä½œï¼‰"
            >
              {board.map((v, i) => (
                <div key={i} className={"aspect-square rounded-2xl flex items-center justify-center text-2xl font-extrabold shadow " + (v === 0 ? "bg-neutral-800 text-neutral-600" : "bg-yellow-400/90 text-black")}>
                  {v === 0 ? "" : v}
                </div>
              ))}
            </div>

            <div className="mt-3 grid grid-cols-3 gap-2 sm:w-2/3">
              <div />
              <button className="rounded-2xl bg-neutral-800 px-3 py-2 text-white" onClick={() => move("ArrowUp")} aria-label="å‘ä¸Š">â¬†ï¸</button>
              <div />
              <button className="rounded-2xl bg-neutral-800 px-3 py-2 text-white" onClick={() => move("ArrowLeft")} aria-label="å‘å·¦">â¬…ï¸</button>
              <div />
              <button className="rounded-2xl bg-neutral-800 px-3 py-2 text-white" onClick={() => move("ArrowRight")} aria-label="å‘å³">â¡ï¸</button>
              <div />
              <button className="rounded-2xl bg-neutral-800 px-3 py-2 text-white" onClick={() => move("ArrowDown")} aria-label="å‘ä¸‹">â¬‡ï¸</button>
              <div />
            </div>

            {over && <p className="mt-3 text-center text-sm text-red-300">æ²’æœ‰å¯ç§»å‹•æ­¥æ•¸å›‰ï¼ä½ å¯ä»¥æŒ‰ã€Œé‡æ–°é–‹å§‹ã€æˆ–ã€Œä¸Šå‚³åˆ†æ•¸ã€ã€‚</p>}
          </div>
        );
      }

      // ========= Leaderboard =========
      function Leaderboard({ data, highlight }) {
        const [q, setQ] = useState("");
        const filtered = useMemo(() => {
          return data
            .filter((d) => [d.name, d.plant, d.dept].join(" ").toLowerCase().includes(q.toLowerCase()))
            .slice(0, 100);
        }, [data, q]);

        return (
          <div className="w-full">
            <div className="mb-2 flex items-center gap-2">
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                placeholder="æœå°‹å§“å / å» å€ / éƒ¨é–€"
                className="w-full rounded-2xl bg-neutral-900 px-4 py-3 text-sm text-white placeholder:text-slate-500"
              />
            </div>
            <div className="overflow-hidden rounded-2xl border border-neutral-800">
              <table className="min-w-full divide-y divide-neutral-800">
                <thead className="bg-neutral-900/80">
                  <tr>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">åæ¬¡</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">æš±ç¨±</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">å» å€</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">éƒ¨é–€</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">æ¨¡å¼</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">åˆ†æ•¸</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">æ­¥æ•¸/èª¤å·®</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">æˆç¸¾</th>
                    <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-400">æ™‚é–“</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-neutral-800 bg-black/40">
                  {filtered.map((d, i) => (
                    <tr key={d.id} className={(highlight && d.id === highlight ? "bg-yellow-400/10" : (i % 2 ? "bg-black" : "bg-black/60"))}>
                      <td className="whitespace-nowrap px-3 py-3 text-sm text-slate-300">{i + 1}</td>
                      <td className="whitespace-nowrap px-3 py-3 text-sm font-semibold text-white">{d.name}</td>
                      <td className="whitespace-nowrap px-3 py-3 text-sm text-slate-300">{d.plant}</td>
                      <td className="whitespace-nowrap px-3 py-3 text-sm text-slate-300">{d.dept || "â€”"}</td>
                      <td className="whitespace-nowrap px-3 py-3 text-sm text-slate-300">{d.modeLabel}</td>
                      <td className="whitespace-nowrap px-3 py-3 text-sm font-bold text-yellow-300">{d.score}</td>
                      <td className="whitespace-nowrap px-3 py-3 text-sm text-slate-300">
                        {d.mode === "2048" ? `${d.elapsed} æ­¥` : `Â±${Math.abs(d.elapsed - d.target)} ms`}
                      </td>
                      <td className="whitespace-nowrap px-3 py-3 text-sm text-slate-300">{d.mode === "2048" ? `${d.elapsed} æ­¥` : `${d.elapsed} msï¼ˆç›®æ¨™ ${d.target}ï¼‰`}</td>
                      <td className="whitespace-nowrap px-3 py-3 text-xs text-slate-400">{new Date(d.created_at).toLocaleString()}</td>
                    </tr>
                  ))}
                  {filtered.length === 0 && (
                    <tr>
                      <td colSpan={9} className="px-3 py-6 text-center text-sm text-slate-400">å°šç„¡è³‡æ–™æˆ–ç„¡ç¬¦åˆæœå°‹çµæœ</td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      // ========= Main =========
      function App() {
        const [leaderboard, setLeaderboard] = useState([]);
        const [lastId, setLastId] = useState(undefined);
        const [name, setName] = useState("");
        const [plant, setPlant] = useState(PLANTS[0]);
        const [dept, setDept] = useState("");
        const [gameType, setGameType] = useState("2048");
        const [serverStatus, setServerStatus] = useState("offline"); // connected | offline | error

        useEffect(() => {
          (async () => {
            const cloud = await sbFetchLeaderboard();
            if (cloud) {
              setLeaderboard(cloud);
              setServerStatus("connected");
            }
          })();
        }, []);

        useEffect(() => {
          const t = setInterval(async () => {
            const cloud = await sbFetchLeaderboard();
            if (cloud) {
              setLeaderboard(cloud);
              setServerStatus("connected");
            } else {
              setServerStatus((s) => (s === "connected" ? "error" : s));
            }
          }, 10000);

          const channel = supabase
            .channel("scores-realtime")
            .on("postgres_changes", { event: "*", schema: "public", table: "scores" }, async () => {
              const cloud = await sbFetchLeaderboard();
              if (cloud) {
                setLeaderboard(cloud);
                setServerStatus("connected");
              }
            })
            .subscribe();

          return () => {
            clearInterval(t);
            supabase.removeChannel(channel);
          };
        }, []);

        const sorted = useMemo(() => [...leaderboard].sort((a, b) => b.score - a.score), [leaderboard]);

        const handleIncomingScore = async (game) => {
          const modeMap = { easy: "å…¥é–€ 1,000ms", pro: "é«˜æ‰‹ 750ms", insane: "ç‹‚ç†± 500ms", "2048": "2048" };

          if (!name.trim()) {
            alert("è«‹å…ˆåœ¨å³å´å¡«å¯«ã€æš±ç¨±ã€å†ä¸Šå‚³æˆç¸¾ã€‚");
            return;
          }

          let target = 0, elapsed = 0, score = 0;
          let mode = String(game.mode || game.type || "easy");

          if (mode === "2048") {
            score = Math.max(0, Math.min(500000, Number(game.score || 0)));
            elapsed = Math.max(0, Math.min(10000, Number(game.moves || 0)));
            target = 0;
          } else {
            elapsed = Math.max(0, Math.min(10000, Number(game.elapsed || 0)));
            target = Math.max(100, Math.min(5000, Number(game.target || 1000)));
            score = Math.max(0, Math.min(1000, Number(game.score || 0)));
          }

          const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : "id_" + Math.random().toString(36).slice(2);
          const entry = {
            id, name: name.trim(), plant, dept: dept.trim(),
            mode, modeLabel: modeMap[mode] || mode, target, elapsed, score,
            created_at: nowTS(),
          };

          setLeaderboard((prev) => [entry, ...prev].slice(0, 500));
          setLastId(entry.id);

          const { ok, error } = await sbSubmitScore(entry);
          const cloud = await sbFetchLeaderboard();
          if (cloud && cloud.length > 0) {
            setLeaderboard(cloud);
            setServerStatus("connected");
          } else {
            setServerStatus(ok ? "connected" : "error");
            if (!ok && error) alert("ä¸Šå‚³å¤±æ•—ï¼š" + error + "\nè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚");
          }

          setTimeout(() => document.getElementById("lb_section")?.scrollIntoView({ behavior: "smooth" }), 150);
        };

        const resetAll = () => {
          if (confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿçš„å€‹äººè³‡è¨Šå—ï¼Ÿï¼ˆé›²ç«¯è³‡æ–™ä¸æœƒè¢«åˆªé™¤ï¼‰")) {
            setName(""); setDept(""); setPlant(PLANTS[0]);
          }
        };

        return (
          <div className="min-h-screen w-full bg-gradient-to-b from-black via-slate-950 to-black text-white">
            {/* Header */}
            <header className="sticky top-0 z-10 border-b border-white/10 bg-black/60 backdrop-blur">
              <div className="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
                <div className="flex items-center gap-3">
                  <div className="h-8 w-8 rounded-xl bg-yellow-400" />
                  <div>
                    <p className="text-xs uppercase tracking-widest text-slate-400">Engineer Week Demo</p>
                    <h1 className="text-lg font-bold">å…‰é›»æŒ‘æˆ°ï½œ2048 / Reaction</h1>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <span
                    className={
                      "hidden rounded-full px-3 py-1 text-xs md:inline " +
                      (serverStatus === "connected"
                        ? "bg-emerald-500/20 text-emerald-300"
                        : serverStatus === "error"
                        ? "bg-red-500/20 text-red-300"
                        : "bg-slate-500/20 text-slate-300")
                    }
                    title={
                      serverStatus === "connected"
                        ? "å·²æ¥ä¸Šé›²ç«¯æ’è¡Œæ¦œï¼ˆSupabaseï¼‰"
                        : serverStatus === "error"
                        ? "é›²ç«¯å›æ‡‰ç•°å¸¸ï¼Œæš«ç”¨æœ¬æ©Ÿè³‡æ–™"
                        : "æœªè¨­å®šé›²ç«¯ï¼Œä½¿ç”¨æœ¬æ©Ÿè³‡æ–™"
                    }
                  >
                    {serverStatus === "connected" ? "Cloud: Connected" : serverStatus === "error" ? "Cloud: Error" : "Cloud: Local Only"}
                  </span>
                  <button onClick={resetAll} className="rounded-xl border border-white/10 px-3 py-2 text-xs text-slate-300 hover:bg-white/5">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
                </div>
              </div>
            </header>

            {/* Main */}
            <main className="mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 py-6 md:grid-cols-5">
              {/* Left: Game */}
              <section className="md:col-span-3">
                <div className="rounded-3xl border border-white/10 bg-black/40 p-5 shadow-2xl">
                  <div className="mb-4 flex items-center justify-between">
                    <h2 className="text-xl font-bold">ğŸ•¹ï¸ éŠæˆ²å€ï¼ˆæ‰‹æ©Ÿå¯ç©ï¼å…ç™»å…¥ï¼‰</h2>
                    <div className="flex items-center gap-2">
                      <button onClick={() => setGameType("2048")} className={"rounded-full px-3 py-1 text-xs " + (gameType === "2048" ? "bg-yellow-400 text-black" : "bg-neutral-800 text-white")}>2048</button>
                      <button onClick={() => setGameType("reaction")} className={"rounded-full px-3 py-1 text-xs " + (gameType === "reaction" ? "bg-yellow-400 text-black" : "bg-neutral-800 text-white")}>è¨ˆæ™‚æŒ‘æˆ°</button>
                    </div>
                  </div>
                  {gameType === "2048" ? (
                    <Game2048 onScore={handleIncomingScore} />
                  ) : (
                    <ReactionGame onScore={handleIncomingScore} />
                  )}
                </div>

                {/* How-to */}
                <div className="mt-4 rounded-3xl border border-white/10 bg-black/40 p-5">
                  <h3 className="mb-2 text-lg font-semibold">ç©æ³•èªªæ˜</h3>
                  {gameType === "2048" ? (
                    <ol className="list-decimal space-y-1 pl-6 text-sm text-slate-300">
                      <li>ä»¥æ»‘å‹•ï¼ˆæ‰‹æ©Ÿï¼‰æˆ–æ–¹å‘éµï¼ˆé›»è…¦ï¼‰ç§»å‹•æ–¹å¡Šã€‚</li>
                      <li>ç›¸åŒæ•¸å­—æœƒåˆä½µæˆæ›´å¤§çš„æ•¸å­—ï¼Œä¸¦ç´¯ç©åˆ†æ•¸ã€‚</li>
                      <li>æ¯ä¸€æ­¥æœƒéš¨æ©Ÿç”Ÿæˆæ–°æ–¹å¡Šï¼ˆ2 æˆ– 4ï¼‰ã€‚</li>
                      <li>æ²’æœ‰å¯ç§»å‹•æ­¥æ•¸å³çµæŸï¼Œå¯æŒ‰ã€Œä¸Šå‚³åˆ†æ•¸ã€ã€‚</li>
                    </ol>
                  ) : (
                    <ol className="list-decimal space-y-1 pl-6 text-sm text-slate-300">
                      <li>é¸æ“‡é›£åº¦ï¼ˆç›®æ¨™æ™‚é–“ï¼‰ã€‚</li>
                      <li>æŒ‰ã€Œé–‹å§‹ã€å¾Œï¼Œç›¯è‘—å¤§åœ“åœˆè¨ˆæ™‚ã€‚</li>
                      <li>åœ¨ä½ è¦ºå¾—æ¥è¿‘ç›®æ¨™æ™‚é–“æ™‚æŒ‰ã€Œåœæ­¢ã€ã€‚</li>
                      <li>åˆ†æ•¸ï¼1000 âˆ’ |å¯¦éš› âˆ’ ç›®æ¨™|ï¼ˆè¶Šæ¥è¿‘è¶Šé«˜ï¼‰ã€‚</li>
                      <li>æŒ‰ã€Œä¸Šå‚³æˆç¸¾ã€å³å¯é€å‡ºè‡³å³å´æ’è¡Œæ¦œã€‚</li>
                    </ol>
                  )}
                </div>
              </section>

              {/* Right: Profile + Leaderboard */}
              <aside className="md:col-span-2">
                <div className="rounded-3xl border border-white/10 bg-black/40 p-5">
                  <h2 className="mb-3 text-xl font-bold">ğŸ‘¤ åƒè³½è€…è³‡è¨Šï¼ˆå…ç™»å…¥ï¼‰</h2>
                  <div className="space-y-3">
                    <div>
                      <label className="mb-1 block text-xs text-slate-400">æš±ç¨±ï¼ˆå¿…å¡«ï¼‰</label>
                      <input value={name} onChange={(e) => setName(e.target.value)} placeholder="ä¾‹å¦‚ï¼šå…‰ä¹‹å·¥ç¨‹å¸«_Lin" className="w-full rounded-2xl bg-neutral-900 px-4 py-3 text-white placeholder:text-slate-500" />
                    </div>
                    <div>
                      <label className="mb-1 block text-xs text-slate-400">å» å€</label>
                      <select value={plant} onChange={(e) => setPlant(e.target.value)} className="w-full rounded-2xl bg-neutral-900 px-4 py-3 text-white">
                        {PLANTS.map((p) => <option key={p} value={p}>{p}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="mb-1 block text-xs text-slate-400">éƒ¨é–€ï¼ˆé¸å¡«ï¼‰</label>
                      <input value={dept} onChange={(e) => setDept(e.target.value)} placeholder="å¦‚ï¼šç ”ç™¼ä¸€è™• / è£½é€ äºŒå» " className="w-full rounded-2xl bg-neutral-900 px-4 py-3 text-white placeholder:text-slate-500" />
                    </div>
                    <p className="text-xs text-slate-500">å‚™è¨»ï¼šæ­¤é å€‹è³‡åƒ…å­˜æ–¼ç€è¦½å™¨è¨˜æ†¶ï¼›é›²ç«¯åƒ…å­˜æˆç¸¾ã€‚</p>
                  </div>
                </div>

                <div id="lb_section" className="mt-4 rounded-3xl border border-white/10 bg-black/40 p-5">
                  <div className="mb-3 flex items-center justify-between">
                    <h2 className="text-xl font-bold">ğŸ† å³æ™‚æ’è¡Œæ¦œ</h2>
                    <span className="rounded-full bg-blue-500/20 px-3 py-1 text-xs text-blue-300">ä¾åˆ†æ•¸é«˜â†’ä½æ’åº</span>
                  </div>
                  <Leaderboard data={sorted} highlight={lastId} />
                </div>
              </aside>
            </main>

            <footer className="mx-auto max-w-6xl px-4 pb-10 pt-4 text-center text-xs text-slate-500">å¯Œé‡‡ Engineer Week ç·šä¸ŠæŒ‘æˆ°ï½œç¤ºç¯„é ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼å…ç™»å…¥ï¼‰</footer>
          </div>
        );
      }

      try {
        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
      } catch (e) {
        showError('[Render] ' + (e && e.stack ? e.stack : e));
      }

      // ====================
      // Dev Sanity Tests
      // ====================
      (function runDevTests(){
        try {
          // 2048 rotate & slide åŸºæœ¬æ¸¬è©¦
          const SIZE=4; const idx=(r,c)=>r*SIZE+c;
          const rotate=(b)=>{const nb=Array(16).fill(0);for(let r=0;r<SIZE;r++){for(let c=0;c<SIZE;c++){nb[idx(c,SIZE-1-r)]=b[idx(r,c)];}}return nb;};
          const baseline=[...Array(16)].map((_,i)=>i);
          const rotated=rotate(baseline);
          console.debug('[TEST] rotate ok?', rotated[0]===12 && rotated[5]===9);

          const slide=(arr)=>{const nums=arr.filter(v=>v!==0);const out=[];let gained=0;for(let i=0;i<nums.length;i++){if(i<nums.length-1 && nums[i]===nums[i+1]){const v=nums[i]*2;out.push(v);gained+=v;i++;}else out.push(nums[i]);}while(out.length<SIZE)out.push(0);return{row:out,gained}};
          const s=slide([2,2,4,4]);
          console.debug('[TEST] slide ok?', JSON.stringify(s.row)===JSON.stringify([4,8,0,0]) && s.gained===12);

          // Supabase client å¯ç”¨æ€§
          console.debug('[TEST] supabase client', !!window.supabaseClient);
        } catch (err) {
          console.warn('[TEST] Failed', err);
        }
      })();
    } catch (e) {
      showError('[Bootstrap] ' + (e && e.stack ? e.stack : e));
    }
  });
  </script>

  <!--
  ==============================
  Supabase `scores` å»ºè¡¨èˆ‡ RLSï¼ˆè«‹åœ¨ SQL Editor åŸ·è¡Œï¼‰
  ==============================
  create table if not exists public.scores (
    id         text primary key,
    name       text not null,
    plant      text not null,
    dept       text,
    mode       text not null,        -- 'easy' | 'pro' | 'insane' | '2048'
    modeLabel  text not null,
    target     integer not null,     -- reaction ç›®æ¨™æ¯«ç§’ï¼›2048 ä¸€å¾‹ 0
    elapsed    integer not null,     -- reaction å¯¦éš›æ¯«ç§’ï¼›2048 æ­¥æ•¸
    score      integer not null check (score >= 0),
    created_at timestamptz not null default now()
  );

  alter table public.scores enable row level security;

  create policy if not exists scores_select_public
  on public.scores for select to anon using (true);

  create policy if not exists scores_insert_public
  on public.scores for insert to anon with check (
    score between 0 and 500000
    and elapsed between 0 and 10000
    and target between 0 and 5000
    and char_length(name) between 1 and 40
  );

  -- Realtimeï¼šDatabase â†’ Replication â†’ Configure â†’ å‹¾é¸ `scores`
  -->
</body>
</html>
